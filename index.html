<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BB-8 Voice Come Controller</title>
<style>
  :root{--bg:#0d1117;--panel:#111318;--accent:#ff8c00;--text:#f5f5f5}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Arial;text-align:center}
  .wrap{max-width:760px;margin:48px auto;padding:20px}
  h1{font-size:2rem;margin:0 0 14px}
  button{background:var(--accent);border:none;padding:12px 22px;border-radius:12px;color:#fff;font-size:17px;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.3)}
  button:active{transform:translateY(1px)}
  .status{margin-top:12px;font-size:16px}
  .log{margin-top:12px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.03);text-align:left;font-family:monospace;white-space:pre-wrap;height:120px;overflow:auto}
  .controls{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  input[type="text"]{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#0b0e13;color:var(--text);min-width:180px}
  .small{font-size:0.88rem;color:#cfcfcf;margin-top:8px}
  .muted{opacity:.75}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ü§ñ BB-8 Voice ‚ÄúCome‚Äù Controller</h1>

    <div>
      <button id="connectBtn">üîó Connect BB-8</button>
    </div>

    <div class="status" id="status">Status: ready (not connected)</div>

    <div class="controls" id="controls" style="display:none">
      <button id="startVoiceBtn">üé§ Start Listening</button>
      <button id="stopVoiceBtn" style="display:none">‚è∏Ô∏è Stop Listening</button>
      <button id="manualFollowBtn">‚ñ∂ Manual Come</button>
      <button id="manualStopBtn">‚ñ† Stop</button>
    </div>

    <div class="controls" style="margin-top:10px; justify-content:center;">
      <input id="cmdInput" type="text" placeholder='Type "come" or "stop"' />
      <button id="sendCmdBtn" class="btn-ghost">Send</button>
      <button id="clearLogBtn" class="btn-ghost">Clear Log</button>
    </div>

    <div class="log" id="log">Console/log will appear here.</div>
    <p class="small muted">Say or type <strong>‚Äúcome‚Äù</strong> to make BB-8 roll and <strong>‚Äústop‚Äù</strong> to halt. Chrome on Android / secure origin required.</p>
  </div>

<script>
(() => {
  // --- CONFIG ---
  const CONTROL_SERVICE_UUID = '22bb746f-2ba0-7554-2d6f-726568705327';
  const TX_CHARACTERISTIC_UUID = '22bb746f-2ba1-7554-2d6f-726568705327';
  const DEVICE_NAME_PREFIXES = ['BB', 'BB-', 'BB-DB', 'Sphero']; // helps the device picker
  const ROLL_SPEED = 120;                // 0-255 -- adjust for "closer" or "slower"
  const ROLL_SEND_INTERVAL_MS = 600;     // resends roll command so it keeps going
  // ------------------

  let bb8Device = null;
  let gattServer = null;
  let txCharacteristic = null;
  let followInterval = null;
  let recognition = null;

  const $ = sel => document.querySelector(sel);
  const logEl = $('#log');
  function log(...args){ console.log(...args); logEl.textContent += '\n' + args.map(a => (typeof a==='object'? JSON.stringify(a): String(a))).join(' '); logEl.scrollTop = logEl.scrollHeight; }
  function setStatus(text){ $('#status').innerText = 'Status: ' + text; log('[STATUS]', text); }
  function playChirp(){ try{ new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play(); }catch(e){} }
  function uint8From(...nums){ return new Uint8Array(nums); }
  async function writeTx(cmd) {
    if(!txCharacteristic) { log('tx not ready'); return; }
    try { await txCharacteristic.writeValue(cmd); } catch(e){ log('write error', e); }
  }

  // Build Sphero roll/stop bytes (simple format used elsewhere)
  function makeRollCmd(speed = ROLL_SPEED, heading = 0){
    // [0x02, 0x30, 0x01, speed, heading]
    return uint8From(0x02, 0x30, 0x01, speed & 0xFF, heading & 0xFF);
  }
  function makeStopCmd(){
    return uint8From(0x02, 0x32, 0x01, 0x00, 0x00);
  }

  async function startFollowing(){
    if (!txCharacteristic) { log('not connected'); return; }
    if (followInterval) { log('already following'); return; }
    playChirp(); setStatus('Rolling (come)...');
    await writeTx(makeRollCmd(ROLL_SPEED, 0));
    // keep sending roll pulses so BB stays moving
    followInterval = setInterval(()=> writeTx(makeRollCmd(ROLL_SPEED, 0)), ROLL_SEND_INTERVAL_MS);
  }

  async function stopFollowing(){
    if (followInterval){ clearInterval(followInterval); followInterval = null; }
    if (!txCharacteristic) { setStatus('Stopped (not connected)'); return; }
    await writeTx(makeStopCmd());
    playChirp(); setStatus('Stopped');
  }

  async function connectToDevice(){
    if (!navigator.bluetooth) {
      alert('Web Bluetooth not supported in this browser.');
      return;
    }
    setStatus('Requesting device...');
    try {
      bb8Device = await navigator.bluetooth.requestDevice({
        filters: DEVICE_NAME_PREFIXES.map(p => ({ namePrefix: p })),
        optionalServices: [CONTROL_SERVICE_UUID]
      });
      log('chosen device:', bb8Device.name || bb8Device.id);
      gattServer = await bb8Device.gatt.connect();
      const srv = await gattServer.getPrimaryService(CONTROL_SERVICE_UUID);
      txCharacteristic = await srv.getCharacteristic(TX_CHARACTERISTIC_UUID);
      setStatus('‚úÖ Connected to ' + (bb8Device.name || 'BB-8'));
      $('#controls').style.display = 'flex';
      startRecognition(); // auto-start listening once connected (you can stop)
      bb8Device.addEventListener('gattserverdisconnected', () => {
        setStatus('Disconnected');
        txCharacteristic = null;
        $('#controls').style.display = 'none';
        if(followInterval){ clearInterval(followInterval); followInterval = null; }
      });
    } catch(err){
      log('connect error', err);
      setStatus('‚ùå Connection failed');
    }
  }

  // --- Speech recognition (Chrome) ---
  function ensureRecognition(){
    if (recognition) return recognition;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert('Speech Recognition not supported in this browser.');
      return null;
    }
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onstart = () => {
      $('#startVoiceBtn').style.display='none';
      $('#stopVoiceBtn').style.display='inline-block';
      setStatus('üé§ Listening for "come"/"stop"');
    };
    recognition.onend = () => {
      $('#startVoiceBtn').style.display='inline-block';
      $('#stopVoiceBtn').style.display='none';
      setStatus('Speech stopped');
    };
    recognition.onerror = e => log('speech error', e);
    recognition.onresult = async ev => {
      const phrase = ev.results[ev.results.length-1][0].transcript.trim().toLowerCase();
      log('heard:', phrase);
      if (phrase.includes('come')) { log('VOICE -> come'); await startFollowing(); }
      else if (phrase.includes('stop')) { log('VOICE -> stop'); await stopFollowing(); }
      else { log('VOICE unrecognized:', phrase); }
    };
    return recognition;
  }
  function startRecognition(){ const r = ensureRecognition(); if(r) try{ r.start(); } catch(e){ log('speech start error', e); } }
  function stopRecognition(){ if(recognition) try{ recognition.stop(); } catch(e){ log('speech stop error', e); } }

  // typed or button commands
  async function handleCommand(cmd){
    if(!cmd) return;
    const c = cmd.trim().toLowerCase();
    log('CMD:', c);
    if (c === 'come' || c === 'come!') { await startFollowing(); }
    else if (c === 'stop') { await stopFollowing(); }
    else { log('Unknown command:', c); setStatus('Unknown command: ' + c); }
  }

  // UI wiring
  $('#connectBtn').addEventListener('click', connectToDevice);
  $('#startVoiceBtn').addEventListener('click', startRecognition);
  $('#stopVoiceBtn').addEventListener('click', stopRecognition);
  $('#manualFollowBtn').addEventListener('click', startFollowing);
  $('#manualStopBtn').addEventListener('click', stopFollowing);
  $('#sendCmdBtn').addEventListener('click', ()=> handleCommand($('#cmdInput').value));
  $('#clearLogBtn').addEventListener('click', ()=> logEl.textContent = 'Console/log will appear here.');

  // initialize
  setStatus('Ready ‚Äî press Connect BB-8');

  // expose for console debugging if needed
  window._bb8 = { startFollowing, stopFollowing, connectToDevice };
})();
</script>
</body>
</html>
